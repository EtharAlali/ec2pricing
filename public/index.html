<!DOCTYPE html>

<html ng-app="ec2Pricing">
  <head>
    <meta charset="utf-8" />
    <meta name="fragment" content="!" />
    <title>EC2 Instance Types &amp; Pricing</title>
    <link rel="stylesheet" type="text/css" href="css/bootstrap-2.0.4-custom.min.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap-responsive-2.0.4.min.css" />
    <link rel="stylesheet" type="text/css" href="css/font-awesome-2.0.css" />
    <style type="text/css">
    body {
      margin-top: 1em;
    }

    .numeric {
      text-align: right !important;
    }

    table.instance-properties {
      width: 100%;
    }

    .region-tabs {
      margin-bottom: 0;
    }

    tr.not-available {
      opacity: 0.5;
    }

    .text-right {
      text-align: right;
    }

    .component-right {
      float: right;
    }

    footer {
      margin-top: 4em;
      font-size: 80%;
      border-top: 1px solid #EEE;
      padding-top: 1em;
    }
    </style>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.string/2.0.0/underscore.string.min.js"></script>
    <script type="text/javascript" src="lib/angular-1.0.1/angular-1.0.1.min.js"></script>
    <script type="text/javascript" src="app/module.js"></script>
    <script type="text/javascript" src="app/pricing.js"></script>
    <script type="text/javascript">
    angular.module("ec2Pricing").
      config(function ($locationProvider) {
        $locationProvider.hashPrefix('!')
      })

    var ApplicationController = function ($scope, $http, $location, $timeout, instanceTypesLoader, pricingLoader, pricingParser) {
      var ioSortOrder = ["low", "moderate", "high", "very high"]
      var typeClassSortOrder = ["m1", "t1", "c1", "m2", "cc1", "cc2", "cg1"]
      var typeSizeSortOrder = ["micro", "small", "medium", "large", "xlarge", "2xlarge", "4xlarge", "8xlarge"]
      var periodMultipliers = {"hourly": 1, "daily": 24, "weekly": 7 * 24, "monthly": 30.4 * 24, "yearly": 365.25 * 24}

      $scope.pricing = null
      $scope.regions = null
      $scope.selectedRegion = null
      $scope.sortField = null
      $scope.sortAscending = false
      $scope.operatingSystems = {"linux": "Linux", "mswin": "Windows"}
      $scope.selectedOs = null
      $scope.periods = ["hourly", "daily", "weekly", "monthly", "yearly"]
      $scope.selectedPeriod = null
      $scope.singularPeriods = {"hourly": "hour", "daily": "day", "weekly": "week", "monthly": "month", "yearly": "year"}

      var sortInstanceTypes = function () {
        if ($scope.selectedRegion) {
          var field = $scope.sortField

          var availableTypes = _($scope.selectedRegion.instanceTypes).select(function (instanceType) {
            return !!instanceType.pricing[$scope.selectedOs]
          })
          var unavailableTypes = _($scope.selectedRegion.instanceTypes).select(function (instanceType) {
            return !instanceType.pricing[$scope.selectedOs]
          })

          if (field == "type") {
            availableTypes = sortInstanceTypesByType(availableTypes, $scope.sortAscending)
          } else if (field == "price") {
            availableTypes = sortInstanceTypesByPrice(availableTypes, $scope.selectedOs, $scope.sortAscending)
          } else if (field == "spotPrice") {
            // TODO: move instances without spotPrice to the unavailable list
            availableTypes = sortInstanceTypesByPrice(availableTypes, $scope.selectedOs, $scope.sortAscending)
          } else {
            availableTypes = sortInstanceTypesBy(availableTypes, field, $scope.sortAscending)
          }

          $scope.selectedRegion.instanceTypes = availableTypes.concat(unavailableTypes)
        }
      }

      var sortInstanceTypesByType = function (instanceTypes, sortAscending) {
        instanceTypes.sort(function (i0, i1) {
          var c0 = i0.type.split(".")
          var c1 = i1.type.split(".")
          var comp = typeClassSortOrder.indexOf(c0[0]) - typeClassSortOrder.indexOf(c1[0])
          var order = comp
          if (comp == 0) {
            order = typeSizeSortOrder.indexOf(c0[1]) - typeSizeSortOrder.indexOf(c1[1])
          }
          return order * (sortAscending ? -1 : 1)
        })
        return instanceTypes
      }

      var sortInstanceTypesByPrice = function (instanceTypes, selectedOs, sortAscending) {
        var sortedInstanceTypes = _(instanceTypes).sortBy(function (instance) {
          return instance.pricing[selectedOs]
        })
        if (!sortAscending) {
          sortedInstanceTypes.reverse()
        }
        return sortedInstanceTypes
      }

      var sortInstanceTypesBy = function (instanceTypes, field, sortAscending) {
        var sortedInstanceTypes = _(instanceTypes).sortBy(function (instance) {
          var value = instance[field]
          if (field == "ram" || field == "disk") {
            if (!value) {
              return 0
            }
            var m = value.match(/([\d.]+) ([GM]B)/)
            var size = parseFloat(m[1])
            if (m[2] == "MB") {
              size = size/1024
            }
            return size
          } else if (field == "architectures") {
            return instance.architectures.join("/")
          } else if (field == "io") {
            return ioSortOrder.indexOf(value)
          } else {
            return instance[field]
          }
        })

        if (!sortAscending) {
          sortedInstanceTypes.reverse()
        }
        
        return sortedInstanceTypes
      }

      var updateState = function (firstTime) {
        if ($scope.selectedRegion) {
          var oldPath = $location.path()
          $location.path($scope.selectedRegion.apiName)
          $location.search({
            sort: $scope.sortField + ":" + ($scope.sortAscending ? "asc" : "desc"),
            os: $scope.selectedOs,
            period: $scope.selectedPeriod
          })
          if (oldPath != $location.path()) {
            trackPageview()
          }
        }
      }

      var restoreState = function () {
        var state = $location.search()

        $scope.selectedOs = state.os || "linux"
        $scope.selectedPeriod = state.period || "hourly"
        
        if (state.sort) {
          var sortState = state.sort.split(":")
          $scope.sortField = sortState[0]
          $scope.sortAscending = sortState[1].toLowerCase() == "asc"
        } else {
          $scope.sortField = "type"
          $scope.sortAscending = false
        }

        var region = $location.path().substring(1)

        selectRegion(region || "us-east-1")

        trackPageview()
      }

      var selectRegion = function (r) {
        $scope.selectedRegion = $scope.pricing[r]
      }

      var trackPageview = function () {
        _gaq.push(['_trackPageview', $location.path()])
      }

      var trackEvent = function (category, action) {
        _gaq.push(['_trackEvent', category, action])
      }
      
      var stateFields = ["sortField", "sortAscending", "selectedRegion", "selectedOs", "selectedPeriod"]
      stateFields.forEach(function (property) {
        $scope.$watch(property, sortInstanceTypes)
        $scope.$watch(property, updateState)
      })

      $scope.isSelectedRegion = function (r) {
        return r == $scope.isSelectedRegion
      }

      $scope.selectRegion = function ($event, r) {
        $event.preventDefault()
        selectRegion(r)
      }

      $scope.selectOs = function ($event, o) {
        $event.preventDefault()
        $scope.selectedOs = o
        trackEvent("Select OS", o)
      }

      $scope.selectPeriod = function ($event, p) {
        $event.preventDefault()
        $scope.selectedPeriod = p
        trackEvent("Select Period", p)
      }

      $scope.sortBy = function ($event, f) {
        $event.preventDefault()

        if ($scope.sortField == f) {
          $scope.sortAscending =  !$scope.sortAscending
        } else {
          $scope.sortAscending = false
        }

        $scope.sortField = f

        trackEvent("Sort By Column", f)
      }

      $scope.regionTabClass = function (r) {
        return r == $scope.selectedRegion.apiName ? "active" : ""
      }

      $scope.osSelectorClass = function (o) {
        return o == $scope.selectedOs ? "active" : ""
      }

      $scope.instanceTypeRowClass = function (instanceType) {
        return instanceType.pricing[$scope.selectedOs] ? "" : "not-available"
      }

      $scope.periodSelectorClass = function (p) {
        return p == $scope.selectedPeriod ? "active" : ""
      }

      $scope.calculatedPrice = function (instanceType) {
        var basePrice = instanceType.pricing[$scope.selectedOs]
        var multiplier = periodMultipliers[$scope.selectedPeriod]
        var price = basePrice * multiplier
        // var decimals = Math.max(0, 3 - Math.floor(Math.log(multiplier)/Math.log(10)))
        var decimals = 3
        if (multiplier > 100) {
          decimals = 0
        } else if (multiplier > 1) {
          decimals = 2
        }
        if (price > 0.0001) {
          // TODO: thousands-separators!
          return _.str.sprintf("$%." + decimals + "f", price)
        } else {
          return null
        }
      }

      $scope.spotPrice = function (instanceType) {
        if ($scope.spotInstancePricing) {
          var regionPricing = $scope.spotInstancePricing[$scope.selectedRegion.apiName]
          var foundInstanceType = _(regionPricing.instanceTypes).find(function (it) { return it.type == instanceType.type })
          if (foundInstanceType) {
            return $scope.calculatedPrice(foundInstanceType)
          }
        }
        return null
      }

      $scope.inspectInstanceType = function (instanceType) {
        console.log(instanceType)
      }

      var startUpdateSpotPricing = function () {
        pricingLoader.spot().then(function (spotPricing) {
          $scope.spotInstancePricing = spotPricing
        })
        $timeout(arguments.callee, 300000)
      }

      var mergeInstanceTypesIntoPricing = function (instanceTypes, pricing) {
        _(pricing).each(function (region) {
          _(region.instanceTypes).each(function (instanceType) {
            if (instanceType.type in instanceTypes) {
              _(instanceType).extend(instanceTypes[instanceType.type])
            } else {
              console.log("No instance type data for", instanceType.type)
            }
          })
        })
      }

      instanceTypesLoader.instanceTypes().then(function (instanceTypes) {
          pricingLoader.onDemand()
            .then(function (onDemandPricing) {
              $scope.lastUpdated = new Date() // TODO
              $scope.instanceTypes = instanceTypes
              $scope.regions = _(onDemandPricing).keys().sort()
              $scope.pricing = onDemandPricing
              mergeInstanceTypesIntoPricing(instanceTypes, onDemandPricing)
            })
            .then(startUpdateSpotPricing)
            .then(restoreState)
        })
    }
    </script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-259801-10']);
    
    if (window.location.host != "localhost") {
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    }
    </script>
  </head>
  <body ng-controller="ApplicationController">
    <div class="container">
      <div class="row">
        <div class="span12">
          <div class="page-header">
            <h1>EC2 Instance Types &amp; Pricing</h1>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="span12">
          <ul class="region-tabs nav nav-tabs">
            <li ng-repeat="region in regions" ng-class="regionTabClass(region)">
              <a href="#" ng-click="selectRegion($event, region)" title="{{pricing[region].name}}">{{region}}</a>
            </li>
          </ul>
          <table class="instance-properties table table-striped">
            <thead>
              <tr>
                <th><a href="#" ng-click="sortBy($event, 'type')">Name</a></th>
                <th></th>
                <th class="numeric"><a href="#" ng-click="sortBy($event, 'type')">API Name</a></th>
                <th class="numeric"><a href="#" ng-click="sortBy($event, 'ecus')" title="EC2 Compute Units">ECUs</a></th>
                <th class="numeric"><a href="#" ng-click="sortBy($event, 'cores')" title="Logical cores">Cores</a></th>
                <th class="numeric"><a href="#" ng-click="sortBy($event, 'architectures')" title="Processor architecture">Arch.</a></th>
                <th class="numeric"><a href="#" ng-click="sortBy($event, 'ram')" title="RAM">RAM</a></th>
                <th class="numeric"><a href="#" ng-click="sortBy($event, 'disk')" title="Total disk size (most instances have multiple disks)">Disk</a></th>
                <th><a href="#" ng-click="sortBy($event, 'io')" title="IO Performance">IO&nbsp;Perf.</a></th>
                <th class="numeric"><a href="#" ng-click="sortBy($event, 'price')" title="On Demand cost per {{singularPeriods[selectedPeriod]}}">Price</a></th>
                <th class="numeric"><a href="#" ng-click="sortBy($event, 'spotPrice')" title="Spot instance cost per {{singularPeriods[selectedPeriod]}} at current rate (updated every five minutes)">Spot&nbsp;price</a></th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="instanceType in selectedRegion.instanceTypes"
                   ng-class="instanceTypeRowClass(instanceType)"
                   ng-click="inspectInstanceType(instanceType)">
                <td>{{instanceType.name}}</td>
                <td title="{{instanceType.notes.join(', ')}}">
                  <i class="icon-info-sign" ng-show="instanceType.notes"></i>
                </td>
                <td>
                  <span class="label label-info">
                    {{instanceType.type}}
                  </span>
                </td>
                <td class="numeric">{{instanceType.ecus}}</td>
                <td class="numeric">{{instanceType.cores}}</td>
                <td class="numeric">{{instanceType.architectures.join("/")}}-bit</td>
                <td class="numeric">{{instanceType.ram}}</td>
                <td class="numeric">{{instanceType.disk || 'n/a'}}</td>
                <td>{{instanceType.io}}</td>
                <td class="numeric">{{calculatedPrice(instanceType) || "n/a"}}</td>
                <td class="numeric">{{spotPrice(instanceType) || "n/a"}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="row">
        <div class="span6">
          <ul class="nav nav-pills">
            <li ng-repeat="(os, osName) in operatingSystems" ng-class="osSelectorClass(os)">
              <a href="#" ng-click="selectOs($event, os)">{{osName}}</a>
            </li>
          </ul>
        </div>
        <div class="span6">
          <ul class="nav nav-pills component-right">
            <li ng-repeat="period in periods" ng-class="periodSelectorClass(period)">
              <a href="#" ng-click="selectPeriod($event, period)">{{period}}</a>
            </li>
          </ul>
        </div>
      </div>
      <footer class="row">
        <div class="span6">
          <p>
            Data from <a href="http://aws.amazon.com/ec2/pricing/">EC2 Pricing</a> and <a href="http://aws.amazon.com/ec2/instance-types/">EC2 Instance Types</a>,
            last updated {{lastUpdated | date}}
          </p>
        </div>
        <div class="span6 text-right">
          <p>
            Created by <a href="http://twitter.com/iconara">Theo Hultberg / @iconara <i class="icon-twitter"></i></a>, 
            find the code at <a href="https://github.com/iconara/ec2pricing">github.com/iconara/ec2pricing <i class="icon-github"></i></a>
          </p>
        </div>
      </footer>
    </div>
  </body>
</html>
